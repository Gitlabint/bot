from flask import Flask, request, redirect, url_for, session, render_template, jsonify
from threading import Thread
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, WebAppInfo
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes
import sqlite3
import random
import string
import os
import requests
import secrets

# === CONFIG ===
app = Flask(__name__)
app.secret_key = os.getenv("FLASK_SECRET", "supersecret")

TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
PUBLIC_BASE_URL = os.getenv("PUBLIC_BASE_URL")  # ex: https://xxx.onrender.com
BOT_USERNAME = os.getenv("BOT_USERNAME", "MyMiningBot")
API_SECRET = os.getenv("API_SECRET", "change_this")

if not TELEGRAM_TOKEN or not PUBLIC_BASE_URL:
    raise ValueError("TELEGRAM_TOKEN and PUBLIC_BASE_URL must be set in env")

# === DB SETUP ===
DB_FILE = "bot.db"
conn = sqlite3.connect(DB_FILE, check_same_thread=False)
cursor = conn.cursor()
cursor.execute('''
CREATE TABLE IF NOT EXISTS users (
    telegram_id INTEGER PRIMARY KEY,
    wallet_address TEXT,
    personal_code TEXT UNIQUE,
    referral_code_used TEXT,
    avatar_cadran TEXT DEFAULT 'classique',
    avatar_bracelet TEXT DEFAULT 'cuir',
    avatar_aiguilles TEXT DEFAULT 'standard'
)
''')
conn.commit()

def generate_referral_code(length=6):
    return ''.join(random.choices(string.ascii_uppercase + string.digits, k=length))

def add_user(telegram_id, wallet_address):
    personal_code = generate_referral_code()
    cursor.execute("""
        INSERT OR IGNORE INTO users (telegram_id, wallet_address, personal_code)
        VALUES (?, ?, ?)
    """, (telegram_id, wallet_address, personal_code))
    conn.commit()

def is_user_registered(user_id):
    cursor.execute("SELECT 1 FROM users WHERE telegram_id=?", (user_id,))
    return cursor.fetchone() is not None

def get_user(user_id):
    cursor.execute("SELECT * FROM users WHERE telegram_id=?", (user_id,))
    return cursor.fetchone()

def update_avatar(user_id, cadran, bracelet, aiguilles):
    cursor.execute("""
        UPDATE users SET avatar_cadran=?, avatar_bracelet=?, avatar_aiguilles=?
        WHERE telegram_id=?
    """, (cadran, bracelet, aiguilles, user_id))
    conn.commit()

# === FLASK ROUTES ===
@app.route("/")
def home():
    return "Bot1 + MiniApp running"

@app.route("/app")
def mini_app():
    uid = request.args.get("uid")
    if not uid:
        return "Missing uid", 400
    return render_template("app.html", uid=uid, public_base=PUBLIC_BASE_URL)

@app.route("/user/<int:uid>")
def get_user_data(uid):
    cursor.execute("SELECT telegram_id, wallet_address, personal_code, referral_code_used, avatar_cadran, avatar_bracelet, avatar_aiguilles FROM users WHERE telegram_id=?", (uid,))
    row = cursor.fetchone()
    if not row:
        return jsonify({"error": "not found"}), 404
    return jsonify({
        "telegram_id": row[0],
        "wallet": row[1],
        "personal_code": row[2],
        "referral_code_used": row[3],
        "avatar": {
            "cadran": row[4],
            "bracelet": row[5],
            "aiguilles": row[6]
        }
    })

@app.route("/update_avatar", methods=["POST"])
def update_avatar_api():
    data = request.get_json() or {}
    uid = data.get("uid")
    cadran = data.get("cadran")
    bracelet = data.get("bracelet")
    aiguilles = data.get("aiguilles")
    if not uid:
        return jsonify({"error": "missing uid"}), 400
    update_avatar(uid, cadran, bracelet, aiguilles)
    return jsonify({"ok": True})

# === BOT ===
def main_menu():
    return ("Bienvenue !", InlineKeyboardMarkup([
        [InlineKeyboardButton("ðŸ”— Connect TON Wallet", callback_data="connect")]
    ]))

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text, kb = main_menu()
    await update.message.reply_text(text, reply_markup=kb)

async def menu_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id
    action = query.data

    if action == "connect":
        nonce = secrets.token_hex(8)
        connect_url = f"{PUBLIC_BASE_URL}/app?uid={user_id}&nonce={nonce}"
        btn = InlineKeyboardMarkup([[
            InlineKeyboardButton("ðŸš€ Ouvrir MiniApp", web_app=WebAppInfo(url=connect_url))
        ]])
        await query.edit_message_text("Clique pour ouvrir la MiniApp :", reply_markup=btn)

# === BOT START ===
def run_bot():
    application = Application.builder().token(TELEGRAM_TOKEN).build()
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CallbackQueryHandler(menu_handler))
    application.run_polling()

# === START BOTH ===
def run():
    app.run(host="0.0.0.0", port=8080)

def keep_alive():
    Thread(target=run).start()

if __name__ == "__main__":
    keep_alive()
    run_bot()
