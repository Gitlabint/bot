<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Endorisum Mini-App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
  <style>
    :root{ --bg:#0f1115; --card:#161a22; --text:#e8eefb; --muted:#9aa7bd; --acc:#5b8cff; }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial }
    header{ padding:16px; display:flex; align-items:center; gap:12px; border-bottom:1px solid #232835; }
    header h1{ font-size:16px; margin:0; font-weight:600; }
    main{ padding:16px; display:grid; gap:16px; max-width:1024px; margin:0 auto }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap }
    .tab{ background:#1b2130; border:1px solid #2a3244; color:var(--text); padding:10px 14px; border-radius:10px; cursor:pointer }
    .tab.active{ background:var(--acc); border-color:var(--acc); color:#fff }
    .card{ background:var(--card); border:1px solid #2a3244; border-radius:16px; padding:16px }
    .row{ display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start }
    .col{ flex:1 1 320px }
    .label{ font-size:12px; color:var(--muted) }
    .val{ font-size:14px; margin:2px 0 10px }
    .btn{ background:#1e2636; border:1px solid #2a3244; color:var(--text); padding:10px 12px; border-radius:10px; cursor:pointer }
    .btn.primary{ background:var(--acc); border-color:var(--acc); color:#fff }
    .outfits{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px }
    .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:12px }
    .nft{ background:#0f131c; border:1px solid #2a3244; border-radius:12px; padding:8px; text-align:center }
    .nft img{ width:100%; height:120px; object-fit:cover; border-radius:8px; background:#090c12 }
    #avatarWrap{ height:340px; background:#0b0e15; border:1px solid #2a3244; border-radius:12px; overflow:hidden }
    footer{ padding:16px; text-align:center; color:var(--muted); font-size:12px }
    a{ color:#aecdff; text-decoration:none }
    .pfp{ width:64px; height:64px; border-radius:50%; object-fit:cover; border:1px solid #2a3244 }
    .inline{ display:flex; align-items:center; gap:10px }
    .input{ background:#0f131c; border:1px solid #2a3244; color:#e8eefb; border-radius:10px; padding:8px 10px; width:100% }
  </style>
</head>
<body>
  <header>
    <h1>Endorisum ‚Ä¢ Mini-App</h1>
  </header>

  <main>
    <div class="tabs">
      <button class="tab active" data-pane="profile">üë§ Profil</button>
      <button class="tab" data-pane="mines">‚õèÔ∏è Mines</button>
      <button class="tab" data-pane="settings">‚öôÔ∏è Param√®tres</button>
      <button class="tab" data-pane="danger">‚ùå Se d√©sinscrire</button>
    </div>

    <!-- Profil -->
    <section class="card" id="pane-profile">
      <div class="row">
        <div class="col">
          <div class="inline" style="margin-bottom:10px">
            <img id="pfp" class="pfp" src="" alt="" onerror="this.style.display='none'">
            <div>
              <div class="label">Handle</div>
              <div class="val" id="handle">‚Äî</div>
            </div>
          </div>

          <div class="label">Telegram ID</div>
          <div class="val" id="tgid">‚Äî</div>

          <div class="label">Wallet TON</div>
          <div class="val" id="wallet">‚Äî</div>

          <div class="label">Code de parrainage</div>
          <div class="val"><span id="code">‚Äî</span> <button class="btn" id="btnShare">Partager</button></div>

          <div class="label">Parrain</div>
          <div class="val" id="sponsor">‚Äî</div>

          <div class="label">Total pioches</div>
          <div class="val" id="pioches">0</div>
        </div>

        <div class="col">
          <div id="avatarWrap"></div>
          <div style="margin-top:10px; display:flex; gap:8px;">
            <button class="btn" id="btnLeft">‚Ü∫ Tourner</button>
            <button class="btn" id="btnRight">‚Üª Tourner</button>
            <button class="btn primary" id="btnCenter">Centrer</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="label" style="margin-bottom:6px">NFT du wallet</div>
        <div class="inline" style="margin-bottom:8px">
          <input id="nftFilter" class="input" placeholder="Filtrer par nom de collection‚Ä¶">
          <button class="btn" id="btnClearFilter">Effacer</button>
        </div>
        <div class="grid" id="nfts"></div>
      </div>
    </section>

    <!-- Mines -->
    <section class="card" id="pane-mines" style="display:none">
      <div class="grid" id="mines"></div>
    </section>

    <!-- Settings -->
    <section class="card" id="pane-settings" style="display:none">
      <div class="label">Bracelet</div>
      <div class="outfits">
        <button class="btn outfit" data-type="bracelet" data-val="metal">M√©tal</button>
        <button class="btn outfit" data-type="bracelet" data-val="leather">Cuir</button>
      </div>
      <div style="margin-top:12px">
        <button class="btn primary" id="saveOutfit">üíæ Enregistrer</button>
      </div>
    </section>

    <!-- Danger -->
    <section class="card" id="pane-danger" style="display:none">
      <p>Se d√©sinscrire supprimera tes donn√©es du jeu (wallet associ√©, avatar, etc.).</p>
      <button class="btn" id="btnUnsub">‚ùå Confirmer la d√©sinscription</button>
    </section>
  </main>

  <footer>¬© Endorisum</footer>

<script>
(function(){
  const qs = new URLSearchParams(window.location.search);
  const uid = qs.get("uid");
  if(!uid){ document.body.innerHTML = "<p style='padding:16px'>Bad UID</p>"; return; }

  const pfp     = document.getElementById('pfp');
  const handle  = document.getElementById('handle');
  const tgid    = document.getElementById('tgid');
  const wallet  = document.getElementById('wallet');
  const code    = document.getElementById('code');
  const sponsor = document.getElementById('sponsor');
  const pioches = document.getElementById('pioches');
  const nftsWrap= document.getElementById('nfts');
  const minesWrap = document.getElementById('mines');

  const tabs = document.querySelectorAll(".tab");
  const panes = {
    profile: document.getElementById('pane-profile'),
    mines: document.getElementById('pane-mines'),
    settings: document.getElementById('pane-settings'),
    danger: document.getElementById('pane-danger'),
  };
  tabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      tabs.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      for (const k in panes) panes[k].style.display = "none";
      panes[btn.dataset.pane].style.display = "block";
      if (btn.dataset.pane === 'mines') loadMines();
    });
  });

  // -------- Avatar (montre simple) --------
  let scene, camera, renderer, avatarGroup;
  function createAvatar(bracelet="metal"){
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0b0e15);

    const w = document.getElementById('avatarWrap').clientWidth;
    const h = document.getElementById('avatarWrap').clientHeight;

    camera = new THREE.PerspectiveCamera(35, w/h, 0.1, 100);
    camera.position.set(0, 0, 3);

    renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(w, h);
    const wrap = document.getElementById('avatarWrap');
    wrap.innerHTML = "";
    wrap.appendChild(renderer.domElement);

    const amb = new THREE.AmbientLight(0xffffff, 0.9); scene.add(amb);

    avatarGroup = new THREE.Group(); scene.add(avatarGroup);

    const tex = new THREE.TextureLoader().load('/static/watch.png'); // place static/watch.png dans /static
    const mat = new THREE.MeshStandardMaterial({map:tex});
    if (bracelet==="leather"){
      mat.color = new THREE.Color(0x5a3825);
      mat.metalness = 0.1;
      mat.roughness = 0.9;
    }
    const watch = new THREE.Mesh(new THREE.CircleGeometry(1.5,64), mat);
    avatarGroup.add(watch);

    (function anim(){ requestAnimationFrame(anim); renderer.render(scene,camera); })();
    document.getElementById('btnLeft').onclick  = ()=> avatarGroup.rotation.y -= 0.3;
    document.getElementById('btnRight').onclick = ()=> avatarGroup.rotation.y += 0.3;
    document.getElementById('btnCenter').onclick= ()=> avatarGroup.rotation.y = 0;
  }
  let avatar = { bracelet:'metal' };

  // -------- Data load --------
  let BOT_USERNAME = "";
  let ALL_NFTS = [];

  async function loadMe(){
    const r = await fetch(`/api/me?uid=${uid}`, {cache:'no-store'});
    const data = await r.json();
    if (!data.registered){
      document.body.innerHTML = "<p style='padding:16px'>Non inscrit. Lance /start dans le bot.</p>";
      return;
    }
    BOT_USERNAME = data.bot_username || "";
    if (data.profile_photo_url) { pfp.src = data.profile_photo_url; pfp.style.display = 'block'; }
    handle.textContent = data.username ? '@'+data.username : '‚Äî';
    tgid.textContent   = data.telegram_id;
    wallet.textContent = data.wallet_address || '‚Äî';
    code.textContent   = data.personal_code || '‚Äî';
    pioches.textContent= data.pioches_total || 0;
    sponsor.textContent= data.invited_by_username ? '@'+data.invited_by_username : '‚Äî';

    avatar = data.avatar || avatar;
    createAvatar(avatar.bracelet);

    ALL_NFTS = data.nfts || [];
    drawNFTs();
  }

  function drawNFTs(filterText=""){
    nftsWrap.innerHTML = "";
    const norm = (s)=> (s||"").toLowerCase();
    const f = norm(filterText);
    (ALL_NFTS||[]).forEach(n=>{
      const name = n.name || '';
      if (f && !norm(name).includes(f)) return;
      const div = document.createElement('div');
      div.className = 'nft';
      div.innerHTML = `<img src="${n.image||''}" alt=""><div style="margin-top:6px; font-size:12px">${name||'NFT'}</div>`;
      nftsWrap.appendChild(div);
    });
  }

  async function loadMines(){
    const r = await fetch('/api/mines'); const data = await r.json();
    minesWrap.innerHTML="";
    (data.mines||[]).forEach(m=>{
      const a=document.createElement('a'); a.className='btn'; a.href=m.url; a.textContent=m.title; a.target="_blank";
      minesWrap.appendChild(a);
    });
  }

  document.getElementById('nftFilter').addEventListener('input', (e)=> drawNFTs(e.target.value));
  document.getElementById('btnClearFilter').addEventListener('click', ()=> { document.getElementById('nftFilter').value=''; drawNFTs(''); });

  // Outfits
  document.querySelectorAll('.outfit').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      avatar[btn.dataset.type] = btn.dataset.val;
      createAvatar(avatar.bracelet);
    });
  });

  document.getElementById('saveOutfit').addEventListener('click', async ()=>{
    await fetch('/api/avatar/update',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ uid, ...avatar })
    });
    Telegram?.WebApp?.HapticFeedback?.notificationOccurred('success');
  });

  // D√©sinscription
  document.getElementById('btnUnsub').addEventListener('click', async ()=>{
    const ok = confirm("Confirmer la d√©sinscription ?");
    if(!ok) return;
    await fetch('/api/unsubscribe',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ uid })
    });
    alert("Compte supprim√©. Relance /start pour te r√©inscrire.");
    Telegram?.WebApp?.close?.();
  });

  // Partage du code (ouvre Telegram si possible)
  document.getElementById('btnShare').addEventListener('click', ()=>{
    const link = `https://t.me/${BOT_USERNAME}?start=${code.textContent.trim()}`;
    const text = `Rejoins-moi sur Endorisum ! Clique ici : ${link}`;
    // Si l‚Äôapp Telegram WebApp expose un moyen d‚Äôouvrir un lien interne :
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.openTelegramLink(link);
      return;
    }
    // Sinon Web Share / fallback
    if (navigator.share){
      navigator.share({ title:"Rejoins-moi sur Endorisum", text, url: link }).catch(()=>{});
    } else {
      prompt("Copie ce lien :", link);
    }
  });

  if (Telegram?.WebApp){ Telegram.WebApp.expand(); Telegram.WebApp.ready(); }
  loadMe();
})();
</script>
</body>
</html>
